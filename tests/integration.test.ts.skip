import { Config } from '@oclif/core';
import HarToMocks from '../src/index.js';
import fsExtra from 'fs-extra';

let config: Config;

beforeAll(async () => {
  const originalEmitWarning = process.emitWarning;
  process.emitWarning = () => {};
  try {
    config = await Promise.race([
      Config.load(),
      new Promise((_, reject) => setTimeout(() => reject(new Error('Config.load() timeout')), 5000))
    ]) as Config;
  } finally {
    process.emitWarning = originalEmitWarning;
  }
}, {timeout: 10000});

beforeEach(() => {
  vi.clearAllMocks();
});

describe('Integration Tests', () => {
  it('without any flag show all requests in .har', async () => {
    const cmd = new HarToMocks(['./tests/mocks/sample.har'], config);
    await expect(cmd.run()).resolves.not.toThrow();
  }, {timeout: 10000});

  it('with url flag should filter requests based on url with case sensitive', async () => {
    const cmd = new HarToMocks(['./tests/mocks/sample.har', '--url=/user'], config);
    await expect(cmd.run()).resolves.not.toThrow();
  }, {timeout: 10000});

  it('should render result table with folder tree without writing files', async () => {
    const cmd = new HarToMocks(['./tests/mocks/sample.har', './mocks', '--dry-run'], config);
    await expect(cmd.run()).resolves.not.toThrow();
  }, {timeout: 10000});

  it('should write files to fs', async () => {
    const cmd = new HarToMocks(['./tests/mocks/sample.har', './mocks'], config);
    await expect(cmd.run()).resolves.not.toThrow();
    expect(fsExtra.writeFileSync).toHaveBeenCalledTimes(3);
  }, {timeout: 10000});

  it('should render with GET and POST requests', async () => {
    const cmd = new HarToMocks(['./tests/mocks/sample.har', './mocks', '--method=GET', '--method=POST'], config);
    await expect(cmd.run()).resolves.not.toThrow();
  }, {timeout: 10000});
});
